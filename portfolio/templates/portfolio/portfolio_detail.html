{% extends "portfolio/base.html" %}
{% block content %}
<style>
    body {
        background: linear-gradient(135deg, #6a11cb, #2575fc);
        font-family: "Segoe UI", Arial, sans-serif;
        color: #fff;
    }

    .portfolio-container {
        max-width: 900px;
        margin: 40px auto;
        padding: 30px 40px;
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(12px);
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    h2 {
        text-align: center;
        margin-bottom: 20px;
        font-weight: 600;
    }

    .portfolio-summary {
        text-align: center;
        margin-bottom: 25px;
        font-size: 16px;
    }

    .portfolio-summary span {
        font-weight: 600;
    }

    .btn {
        display: inline-block;
        padding: 8px 14px;
        margin: 5px;
        background: #fff;
        color: #333;
        border-radius: 8px;
        text-decoration: none;
        transition: 0.3s;
    }

    .btn:hover {
        background: #e6e6e6;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        overflow: hidden;
    }

    table th, table td {
        padding: 12px;
        text-align: center;
    }

    table th {
        background: rgba(255,255,255,0.1);
    }

    table tr:nth-child(even) {
        background: rgba(255,255,255,0.05);
    }

    table tr td a {
        color: #fff;
        text-decoration: underline;
        font-size: 14px;
    }

    .gain-positive {
        color: #00ff7f;
        font-weight: 600;
    }

    .gain-negative {
        color: #ff4d4d;
        font-weight: 600;
    }

    .links {
        margin-top: 20px;
        text-align: center;
    }

    .links a {
        color: #fff;
        text-decoration: underline;
        margin: 0 5px;
    }
</style>

<div class="portfolio-container">
    <h2>{{ object.name }}</h2>
    <p>{{ object.description }}</p>

    <div class="portfolio-summary">
        Invested: <span>${{ object.total_invested_cash|floatformat:2 }}</span> |
        Current: <span id="portfolio-current">calculating…</span> |
        Gain/Loss: <span id="portfolio-gain">calculating…</span>
    </div>

    <div class="links">
        <a href="{% url 'investment-create' %}" class="btn">Add Investment</a>
    </div>

    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Type</th>
                <th>Shares</th>
                <th>Invested</th>
                <th>Current Value (live)</th>
                <th>Gain/Loss (live)</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for inv in object.investments.all %}
            <tr class="inv-row"
                data-ticker="{{ inv.ticker|upper }}"
                data-qty="{{ inv.quantity }}"
                data-invested="{{ inv.invested_cash }}">
                <td>{{ inv.name }}{% if inv.ticker %} ({{ inv.ticker }}){% endif %}</td>
                <td>{{ inv.get_type_display }}</td>
                <td>{{ inv.quantity|floatformat:4 }}</td>
                <td>${{ inv.invested_cash|floatformat:2 }}</td>
                <td><span class="live-value">n/a</span></td>
                <td><span class="live-gain">n/a</span></td>
                <td>
                    <a href="{% url 'investment-edit' inv.pk %}">Edit</a> |
                    <a href="{% url 'investment-delete' inv.pk %}">Delete</a> |
                    <a href="{% url 'transaction-create' inv.pk %}">Add Transaction</a>
                </td>
            </tr>
            {% empty %}
            <tr><td colspan="7">No investments yet.</td></tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="links">
        <a href="{% url 'portfolio-edit' object.pk %}" class="btn">Edit Portfolio</a>
        <a href="{% url 'portfolio-delete' object.pk %}" class="btn">Delete Portfolio</a>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const POLL_MS = 5000;

  async function fetchPrice(ticker) {
    if (!ticker) return null;
    try {
      const resp = await fetch(`/api/ticker-info/?ticker=${encodeURIComponent(ticker)}`);
      const data = await resp.json();
      return (data && data.price !== null) ? parseFloat(data.price) : null;
    } catch {
      return null;
    }
  }

  function fmt(n) {
    return `$${Number(n).toFixed(2)}`;
  }

  function fmtSigned(n) {
    const sign = n > 0 ? '+' : '';
    return `${sign}${fmt(n)}`;
  }

  async function refreshRow(row) {
    const ticker   = (row.dataset.ticker || '').trim().toUpperCase();
    const qty      = parseFloat(row.dataset.qty || '0') || 0;
    const invested = parseFloat(row.dataset.invested || '0') || 0;

    const valueEl = row.querySelector('.live-value');
    const gainEl  = row.querySelector('.live-gain');

    if (!ticker || qty === 0) {
      if (valueEl) valueEl.textContent = 'n/a';
      if (gainEl)  gainEl.textContent  = 'n/a';
      return { value: 0, gain: 0 };
    }

    const price = await fetchPrice(ticker);
    if (price == null) {
      if (valueEl) valueEl.textContent = 'n/a';
      if (gainEl)  gainEl.textContent  = 'n/a';
      return { value: 0, gain: 0 };
    }

    const value = price * qty;
    const gain  = value - invested;

    if (valueEl) valueEl.textContent = fmt(value);
    if (gainEl) {
      gainEl.textContent = fmtSigned(gain);
      gainEl.className = 'live-gain ' + (gain > 0 ? 'gain-positive' : gain < 0 ? 'gain-negative' : '');
    }

    return { value, gain };
  }

  async function refreshAll() {
    const rows = Array.from(document.querySelectorAll('.inv-row'));
    let totalValue    = 0;
    let totalInvested = 0;

    for (const r of rows) {
      const invested = parseFloat(r.dataset.invested || '0') || 0;
      totalInvested += invested;
      const { value } = await refreshRow(r);
      totalValue += value;
    }

    const portCurr = document.getElementById('portfolio-current');
    const portGain = document.getElementById('portfolio-gain');
    const totalGain = totalValue - totalInvested;

    if (portCurr) portCurr.textContent = fmt(totalValue);
    if (portGain) {
      portGain.textContent = fmtSigned(totalGain);
      portGain.className = totalGain > 0 ? 'gain-positive' : totalGain < 0 ? 'gain-negative' : '';
    }
  }

  refreshAll();

  let timer = setInterval(() => {
    if (document.visibilityState === 'visible') {
      refreshAll();
    }
  }, POLL_MS);

  window.addEventListener('beforeunload', () => clearInterval(timer));
});
</script>
{% endblock %}
